<!--

ğŸš© DO NOT EDIT THIS FILE.

This AGENT.md defines core Codex responsibilities and must remain stable.

Stack-specific variations belong in /tech-guides/{language}.md

-->

# AGENT.md â€“ Codex Backend Execution Guide

Welcome! This document defines how Codex contributes to our backend codebase (Go, Python, .NET, Java, Rust). All contributions must follow Clean Architecture, test-first development, and strict API/task alignment.

> ğŸ“˜ For global Codex rules, see [`/AGENTS.md`](../AGENTS.md).
> ğŸ“˜ For task specs, GPT roles, and architecture rules, see [`/ENGINEERING_GUIDE.md`](../ENGINEERING_GUIDE.md).
> ğŸ“ For backend architecture guidance by language, see [`/backend/tech-guides/README.md`](./tech-guides/README.md)

---

## ğŸ‘¥ Project Structure & Roles

This monorepo is organized by architectural ownership:

```
/backend/             â†’ Server logic (Architect-owned)
/frontend/            â†’ Interface logic (Polyglot-owned)
```

* Codex writes backend code based on tasks from The Architect.
* Logic must remain within the task spec. Do not invent flows.
* Clean layering and interface-based design are mandatory.

---

## ğŸ§± Clean Architecture Layers

```
/backend/delivery/    â†’ HTTP handlers (input/output formatting, routing)
/backend/usecase/     â†’ Business logic (pure orchestration)
/backend/repository/  â†’ DB and API access (no business logic)
/backend/domain/      â†’ Optional: core entities and types
/backend/internal/    â†’ Utilities, configs, infrastructure
```

* `delivery â†’ usecase â†’ repository`
* All communication via interfaces
* No logic leakage or shortcut wiring

---

## ğŸ§  Codex Execution Rules

* Follow specs from The Architect without deviation.
* Validate input explicitly.
* Do not inject infrastructure into usecases.
* All env/config access lives in `/backend/internal/infrastructure/`

### ğŸ” Preflight Verification Rule

âœ… Checklist:

* [ ] Inspect existing handlers, usecases, repos
* [ ] Search codebase for similar logic (`grep`/`find`)
* [ ] Check `*_test.go` for coverage
* [ ] Avoid duplication â€” **refactor instead**

---

## ğŸ“– Codex-Required Tech Guides

Codex MUST recursively scan all `.md` files inside the following directories:

* `/backend/tech-guides/api/`
* `/backend/tech-guides/architecture/`
* `/backend/tech-guides/coding/`
* `/backend/tech-guides/devops/`
* `/backend/tech-guides/domain/`
* `/backend/tech-guides/languages/`
* `/backend/tech-guides/security/`
* `/backend/tech-guides/serverless/`
* `/backend/tech-guides/storage/`
* `/backend/tech-guides/testing/`

Codex must also read:

* `/backend/tech-guides/backend_conventions.md`
* `/backend/tech-guides/README.md`

This structure enforces consistency while supporting extensibility.

---

## ğŸ““ Task Tracker Enforcement Rule

All backend Codex tasks must update `/codex_task_tracker.md`:

* **Task Title**
* **Phase**
* **Layer(s)**: delivery, usecase, repository, etc.
* **Status**: âœ… Done, â³ In Progress
* **Context**: backend
* **Notes**
* **Created/Updated date**

â¡ Use `/backend/internal/context/task_logger.go` with `updateTaskTracker()` and `hasDuplicateTask()`.

> Logging is **mandatory** for traceability and memory alignment.

---

## ğŸ“Š Task Format from The Architect

Codex receives tasks in this format:

```
ğŸ’» Codex Task: [Function, Endpoint, Service]
ğŸ› Context: backend | shared
ğŸ“ Layer: delivery | usecase | repository
ğŸŒŸ Objective: what the task delivers

ğŸ§¹ Specs:
- Input: payload, query, params, example
- Validation: rules (e.g. > 0, ISO date)
- Flow: delivery â†’ usecase â†’ repo
- Auth: JWT required (userID, role)
- Response: 200, 400, 403, 500 â€” with examples

ğŸ¥ª Tests:
- Unit: valid, invalid, edge
- Integration: framework-native
- Coverage: â‰¥ 90%

ğŸ“¦ Codex Must Follow:
- Clean layering
- Interface-based DI
- `tech-guides/*.md` conventions

â›” Codex Must NOT:
- Skip tests
- Mix logic across layers
- Inject config/env manually
- Modify `/AGENT.md` directly
```

---

## âœ… Commits & PRs

* 1 PR = 1 task
* Use [Conventional Commits](https://www.conventionalcommits.org/):

  * `feat(api): add /refill endpoint`
  * `fix(repo): handle null user`
* Format by language:

  * Go: `go fmt`
  * Python: `black`, `isort`
  * Java: `google-java-format`
  * .NET: `dotnet format`
  * Rust: `rustfmt`

---

## ğŸ§ª Testing Standards

Codex must test **every branch and scenario**:

| Language | Tools                                     |
| -------- | ----------------------------------------- |
| Go       | `*_test.go`, `httptest`, table-driven     |
| Python   | `pytest`, `httpx.AsyncClient`             |
| Java     | `JUnit`, `MockMvc`, `Mockito`             |
| .NET     | `xUnit`, `FluentAssertions`, `TestServer` |
| Rust     | `#[tokio::test]`, `tower`, `reqwest`      |

Tests must:

* Be colocated with code
* Cover success, failure, unauthorized
* Pass CI with â‰¥ 90% coverage

---

## ğŸ” Auth & Security

* All endpoints must:

  * Require JWT with `userID`, `email`, `role`
  * Use middleware to inject claims
  * Enforce RBAC per spec

NEVER skip authorization logic.

---

## âœ… Summary

This document is the immutable contract for backend execution.

* Clean Architecture enforced
* No scope deviation
* Logs and coverage required
* Codex operates as implementer, not inventor

Refer to `/backend/tech-guides/README.md` for language-specific architecture extensions.
