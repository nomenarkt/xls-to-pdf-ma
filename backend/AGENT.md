<!--

ðŸš« DO NOT EDIT THIS FILE.

This AGENT.md defines core Codex responsibilities and must remain stable.

Stack-specific variations belong in /tech-guides/{language}.md

-->

# AGENT.md â€“ Backend Contributing Guidelines

Welcome! This document defines how to contribute to our backend codebase (e.g., Go, Python, .NET, Java, Rust). All contributions must follow Clean Architecture, test-first development, and strict API/task alignment.

> ðŸ“˜ For global Codex rules, see [`/AGENT.md`](../AGENT.md).  
> ðŸ“š For system-wide task specs, architecture principles, and GPT collaboration rules, see [`/ENGINEERING_GUIDE.md`](../ENGINEERING_GUIDE.md).

## ðŸ‘¥ Project Structure & Roles

This repository has two main folders:

* `/backend` â€“ owned by The Architect (Backend GPT)
* `/frontend` â€“ owned by The Polyglot (Frontend GPT)

The AI-first software engineer works with these GPTs to define features. You receive specs from either GPT, never invent flows, and always write tested, production-ready code.

Use tasks from The Architect for backend logic and APIs. All commits must stay within task scope.

## ðŸª¯ Architecture

Our backend is located under the `/backend` directory and follows Clean Architecture principles with strict layering:

```
/backend/delivery     â†’ HTTP handlers (routes, request validation)
/backend/usecase      â†’ Business logic (pure functions, orchestration)
/backend/repository   â†’ Persistence and external APIs (no business logic)
/backend/domain       â†’ (if needed) Core entities, domain services
```

* Handlers invoke Usecases â†’ Usecases call Repositories.
* Each layer communicates via interfaces.
* No logic leakage across layers.

## ðŸ§  Codex Rules

All shared env accessors must live in `/backend/internal/infrastructure`, never duplicated in `/cmd`. This ensures reusable configuration logic and clean separation of concerns.

* Follow tasks from The Architect exactly.
* Do NOT invent endpoints, fields, or flows.
* Validate inputs strictly and honor task boundaries.
* Maintain interfaces and dependency injection.

## ðŸ“œ Tasks from The Architect

All implementation must follow the task spec format:

* Endpoint, function, or service name
* Layer (`delivery`, `usecase`, `repository`)
* Inputs, validation, flow, authorization
* Response structure and error handling
* Required tests

You may NOT change scope or invent flows without approval.

### ðŸ” Preflight Verification Rule

Before assigning or implementing a task, always verify if the functionality already exists:

âœ… **Checklist**

* [ ] Check `internal/ports/`, `usecase/`, and `delivery/` for related interfaces or logic
* [ ] Grep/search symbols (e.g., `grep -r SignalPublisher ./backend`)
* [ ] Inspect `main.go` or orchestration for prior wiring
* [ ] Confirm presence or absence via `*_test.go`
* [ ] If legacy code exists: **refactor or align**, do NOT duplicate

Use this checklist before every Codex Task to avoid redundant or conflicting implementations.

## ðŸ“ƒ Task Tracker Enforcement Rule

All Codex tasks must **update `/codex_task_tracker.md`** when a task is:

*âœ… Completed
*â³ In Progress (partially implemented)

### Required Fields:

* **Task Title**
* **Phase:** Requirements Analysis, System Design, etc.
* **Layer(s):** delivery, usecase, repository, etc.
* **Status:** âœ… Done, â³ In Progress
* **Context:** backend / frontend
* **Notes:** Description, implementation path, refactoring, merge status, etc.
* **Created date:**
* **Updated date:**

âš  Codex must write to `codex_task_tracker.md` using the native backend logging utility.
For Go projects, use:
`/backend/internal/context/task_logger.go` â†’ `UpdateTaskTracker()` and `hasDuplicateTask()`
â†’ This prevents duplicate rows and ensures consistent formatting.

This centralized rule ensures **unified visibility** and reliable session memory for both GPT and Codex.

> Codex must call this utility on all backend task completions as a **mandatory post-task step**.

---

## âœ… Commits & PRs

* One PR = one feature or fix.
* Use Conventional Commits:

  * `feat(api): add /refill endpoint`
  * `fix(repo): correct null check for user lookup`
* Format with project-specific tools:

  * Go: `go fmt`
  * Python: `black`, `isort`
  * .NET: `dotnet format`
  * Java: `google-java-format`
  * Rust: `rustfmt`

## ðŸ¥ª Testing

All handlers, usecases, and utilities must be covered.
Use language-specific conventions:

* Go: `*_test.go`, table-driven, `httptest`
* Python: `pytest`, `unittest.mock`, `httpx.AsyncClient`
* .NET: `xUnit`, `FluentAssertions`, `TestServer`
* Java: `JUnit`, `Mockito`, `MockMvc`
* Rust: `#[tokio::test]`, `reqwest`, `tower`

Required test types:

* Success paths
* Invalid input
* Unauthorized/missing token
* Edge cases

Test files must be next to the code under test.

## ðŸ”€ TDD Workflow

1. Write failing unit tests for spec coverage.
2. Implement logic to pass all tests.
3. Refactor with green tests.
4. Confirm CI coverage before PR.

Do NOT push untested or commented-out code.

## ðŸ” Auth & Security

* All APIs must require JWT with `userID`, `email`, `role`.
* Use middlewares to extract and inject claims into context.
* Apply least-privilege, role-based access control.

## ðŸ—³ï¸ Codex Task Template

```
ðŸ’» Codex Task: [e.g., /refill endpoint, AuthMiddleware, StoreUser()]
ðŸ§­ Context: backend | shared
ðŸ“ Layer: [delivery | usecase | repository]
ðŸŽ¯ Objective:
[Briefly describe the system-level or user-facing goal.]
ðŸ§¹ Specs:
- **Input:**  
  - JSON body, query params, or path  
  - Example: `{ userID: string, token: string }`
- **Validation Rules:**  
  - e.g., `quantity > 0`, `date must be ISO 8601`
- **Logic Flow:**  
  - Handler: validate input â†’ extract user â†’ call usecase  
  - Usecase: contain all business/domain logic  
  - Repository: database or API access only, no logic
- **Authorization:**  
  - Require JWT with: `userID`, `email`, `role`  
  - Restrict access to allowed roles: `[admin, pharmacist]`
- **Response:**  
  - `200 OK`: `{ status: "success" }`  
  - `400`, `401`, `403`, `500`: structured error object
ðŸ¥ª Tests:
- Unit:
  - Success cases
  - Invalid input
  - Unauthorized access
  - Edge cases
- Integration:
  - Use appropriate tooling:
    - `httptest` (Go)
    - `httpx.AsyncClient` (Python)
    - `TestServer` (.NET)
    - `MockMvc` (Java)
    - `reqwest` or `tower` (Rust)
- Minimum test coverage: 90%
ðŸ“¦ Follow:
- Clean Architecture layering (`/delivery`, `/usecase`, `/repository`)
- Dependency Injection via interfaces
- No shared state, global mutable variables, or business logic in handlers
- Never bypass usecase â†’ repository flow
- Obey constraints from:
  - `/backend/AGENT.md` (immutable core)
  - `/backend/tech-guides/{language}.md`
  - `/backend/tech-guides/backend.md` (shared rules)
â›” Do NOT:
- Repeat logic across layers
- Leave untested or commented-out code
- Inject framework logic into business core
- Modify AGENT.md directly
```

Use this template for all Codex tasks to ensure clarity, safety, and modular delivery.

---

For language-specific execution guidance, refer to `/backend/tech-guides/{language}.md`.

