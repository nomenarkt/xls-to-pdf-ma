<!--

ğŸš© DO NOT EDIT THIS FILE.

This AGENT.md defines core Codex responsibilities and must remain stable.

Stack-specific variations belong in /tech-guides/{language}.md

-->

# AGENT.md â€“ Codex Backend Execution Guide

Welcome! This document defines how Codex contributes to our backend codebase (Go, Python, .NET, Java, Rust). All contributions must follow Clean Architecture, test-first development, and strict API/task alignment.

> ğŸ“˜ For global Codex rules, see [`/AGENTS.md`](../AGENTS.md).
> ğŸ“˜ For task specs, GPT roles, and architecture rules, see [`/ENGINEERING_GUIDE.md`](../ENGINEERING_GUIDE.md).
> ğŸ“ For backend architecture guidance by language, see [`/backend/tech-guides/README.md`](./tech-guides/README.md)

---

## ğŸ‘¥ Project Structure & Roles

```
/backend/             â†’ Server logic (Architect-owned)
/frontend/            â†’ Interface logic (Polyglot-owned)
```

Codex must:

* Implement only what is explicitly scoped in `/docs/backend/<domain>/<module>/TECH_SPEC.backend.md`
* Never invent routes, fields, behavior, or error cases
* Always follow Clean Architecture layering: `delivery â†’ usecase â†’ repository`

---

## ğŸ§± Clean Architecture Layers

```
/backend/delivery/       â†’ HTTP controllers (no logic)
/backend/usecase/        â†’ Pure orchestration and validation
/backend/repository/     â†’ Interfaces to DBs or APIs
/backend/domain/         â†’ Optional core types and value objects
/backend/internal/       â†’ Infrastructure, logging, and environment config
```

Rules:

* Use interfaces for all dependencies
* No business logic in delivery or repository
* No shared mutable state or cross-layer imports

---

## ğŸ§  Codex Execution Rules

* Always reference `TECH_SPEC.backend.md` and PRD if available
* Do not fetch unrelated files or guess structure
* Inject dependencies using interfaces
* All env/config access must be inside `internal/infrastructure/`
* No bypass of architecture for tests or helper logic

---

### ğŸ” Preflight Verification Checklist

âœ… Codex must:

- [ ] Check if similar usecases/repos already exist
- [ ] Reuse interfaces instead of duplicating logic
- [ ] Confirm layer placement: usecase vs repo
- [ ] Write tests before implementation
- [ ] Log all task info to Codex tracker

---

## ğŸ“– Codex-Required Tech Guides

Codex MUST recursively scan all `.md` files inside the following directories:

- `/backend/tech-guides/api/`
- `/backend/tech-guides/architecture/`
- `/backend/tech-guides/coding/`
- `/backend/tech-guides/devops/`
- `/backend/tech-guides/domain/`
- `/backend/tech-guides/languages/`
- `/backend/tech-guides/security/`
- `/backend/tech-guides/serverless/`
- `/backend/tech-guides/storage/`
- `/backend/tech-guides/testing/`
- `/backend/tech-guides/backend_conventions.md`
- `/backend/tech-guides/README.md`

No implementation begins until these are loaded and checked.

---

## ğŸ““ Codex Task Tracker Enforcement

Codex must log every task to `/codex_task_tracker.md`:

* Context: backend
* Task Title
* Phase
* Status: âœ… Done | â³ In Progress
* Layer(s): delivery, usecase, repository
* Domain
* Module
* Epic
* Feature
* Description
* Test Status
* Created/Updated timestamps

Use: `/backend/internal/context/task_logger.go`  
Methods: `updateTaskTracker()`, `hasDuplicateTask()`, `cleanBacklog()`

---

## ğŸ“¦ Codex Task Format

```
ğŸ’» Codex Task: [Function, Endpoint, Usecase]
ğŸ—­ Context: backend
ğŸ“ Layer: delivery | usecase | repository
ğŸ¯ Objective: what it delivers

ğŸ§± Module: [e.g. PDFExport]
ğŸ“¦ Epic: [e.g. Report Generation]
ğŸ”§ Feature: [e.g. Download Filtered Flight Logs]

ğŸ§² Specs:
- Input: request format, query, files
- Validation: type rules, schema constraints
- Flow: sanitize â†’ validate â†’ sort â†’ transform â†’ return
- Auth: JWT with userID, email, role
- Response: 200 OK, 400 Bad Request, etc.

ğŸ§ª Tests:
- Unit: success, invalid, edge
- Integration: HTTP + system boundary
- Coverage: â‰¥ 90%
```

---

## ğŸ§ª Test Expectations

Codex must test **all branches**:

| Language | Tools                                     |
| -------- | ----------------------------------------- |
| Go       | `*_test.go`, `httptest`, testify          |
| Python   | `pytest`, `httpx.AsyncClient`             |
| Java     | `JUnit`, `MockMvc`, `Mockito`             |
| .NET     | `xUnit`, `FluentAssertions`, `TestServer` |
| Rust     | `#[tokio::test]`, `reqwest`, `tower`      |

Tests must be colocated, documented, and CI-enforced.

---

## ğŸ” Auth & Security Rules

* JWT required for all protected routes
* JWT must inject: userID, email, role
* RBAC enforced in usecase layer
* No direct role checks in delivery layer
* No leaking of internal errors or stack traces

---

## âœ… Commits & PRs

* 1 PR = 1 task
* Must use [Conventional Commits](https://www.conventionalcommits.org/)
* Format before push:

  * Go: `go fmt`
  * Python: `black`, `isort`
  * Java: `google-java-format`
  * .NET: `dotnet format`
  * Rust: `rustfmt`

---

## ğŸ“˜ Docs Enforcement

* All backend tasks must trace to:

```
/docs/backend/<domain>/<module>/TECH_SPEC.backend.md
```

* Do not implement anything not documented
* If no spec exists, pause and escalate to Architect GPT

---

## ğŸ”’ Summary

This AGENT.md is non-editable and defines the backend execution contract.

* Strict layering: delivery â†’ usecase â†’ repository
* No invention of routes, structure, or validation
* Tests and logs are mandatory
* Spec-first development only

Always trace to `/docs/backend/` and respect conventions from `tech-guides/`.
